<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å•†å®¶å¾Œå°ç®¡ç†ç³»çµ± - çµ‚æ¥µé€£å‹•ç‰ˆ</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: "Microsoft JhengHei", sans-serif; background: #f9f9f9; }
        #admin-main { display: flex; height: 100vh; flex-direction: column; }
        .header { background: #3F51B5; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .main-body { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 220px; background: white; border-right: 1px solid #eee; overflow-y: auto; }
        .menu-item { padding: 12px 20px; cursor: pointer; color: #555; font-size: 14px; border-bottom: 1px solid #fafafa; transition: all 0.3s ease; }
        .menu-item:hover { background: #f4f6ff; }
        .menu-item.active { background-color: #e8eaf6 !important; color: #3F51B5 !important; border-left: 5px solid #3F51B5; font-weight: bold; }
        .sub-item { padding-left: 40px; font-size: 13px; background: #fafafa; }
        .content { flex: 1; padding: 30px; overflow-y: auto; }
        .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; }
        .edit-btn { background: #FFC107; color: #000; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 8px; }
        .del-btn { background: #F44336; color: #fff; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .login-btn { background: linear-gradient(to right, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 10000; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 500px; max-height: 80vh; overflow-y: auto; }
        .perm-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; font-size: 13px; }
        .role-tag { background: #e8eaf6; color: #3F51B5; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    /* å³ä¸Šè§’ Line æŒ‰éˆ•æ¨£å¼ */
.line-link {
    display: flex;
    align-items: center;
    gap: 6px;
    color: white;
    text-decoration: none;
    font-size: 14px;
    font-weight: bold;
    background: #06C755; /* Line ç¶ è‰² */
    padding: 6px 12px;
    border-radius: 20px;
    transition: 0.3s;
}
.line-link:hover { background: #05a346; }

/* åˆ—è¡¨å…§çš„ Line ç‹€æ…‹æ¨™ç±¤ */
.line-status {
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 5px;
    color: white;
}
.line-on { background: #06C755; }  /* å·²ç¶å®š */
.line-off { background: #ccc; }     /* æœªç¶å®š */
    </style>
</head>
<body>

    <div id="admin-main" style="display: flex;">
        <div class="header">
    <span>ğŸ›’ MY SHOP ç®¡ç†ç³»çµ±</span>
    <div style="display:flex; align-items:center; gap:15px;">
        <a href="#" class="line-link">ğŸ’¬ Line ä¸²è¯</a>
        
        <span>ğŸ‘¤ è€é—† (é–‹ç™¼æ¨¡å¼)</span>
        <button onclick="location.reload()" style="background:none; border:1px solid white; color:white; padding:5px 10px; border-radius:4px; cursor:pointer;">é‡æ–°æ•´ç†</button>
    </div>
</div>
        <div class="main-body">
            <div class="sidebar" id="sidebar-menu"></div>
            <div class="content" id="main-content"></div>
        </div>
    </div>

    <div id="staffModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">æ–°å¢äººå“¡</h3>
            <input type="hidden" id="editId">
            <div style="margin-bottom:15px;">
                <label>é¸æ“‡è·ä½æ¨¡æ¿ (å¯è‡ªå‹•å‹¾é¸æ¬Šé™)ï¼š</label>
                <select id="staffRoleSelect" onchange="autoCheckPermissions(this.value)" style="width:100%; padding:10px; border-radius:50px; border:1px solid #ddd;"></select>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="newName" placeholder="äººå“¡ç¨±å‘¼" style="flex:1; padding:10px; border-radius:50px; border:1px solid #ddd;">
                <input type="email" id="newEmail" placeholder="Email" style="flex:1; padding:10px; border-radius:50px; border:1px solid #ddd;">
            </div>
            <div style="margin-bottom: 15px;">
                <input type="password" id="newPass" placeholder="è¨­å®šå¯†ç¢¼" style="width:100%; padding:10px; border-radius:50px; border:1px solid #ddd; box-sizing: border-box;">
            </div>
            <p><b>æ¬Šé™å¾®èª¿ï¼š</b></p>
            <div id="perm-grid" class="perm-grid"></div>
            <div style="margin-top:20px;">
                <button onclick="saveStaff()" style="width:100%; padding:12px; background:#3F51B5; color:white; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">å„²å­˜äººå“¡è¨­å®š</button>
                <button onclick="closeModal('staffModal')" style="width:100%; padding:10px; background:#eee; border:none; border-radius:5px; margin-top:10px; cursor:pointer;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="roleModal" class="modal">
        <div class="modal-content">
            <h3 id="roleModalTitle">è·ä½æ¨¡æ¿è¨­å®š</h3>
            <div style="margin-bottom:15px;">
                <input type="text" id="roleNameInput" placeholder="è·ä½åç¨± (ä¾‹å¦‚ï¼šè³‡æ·±ç¶­ä¿®å¸«)" style="width:100%; padding:10px; border-radius:50px; border:1px solid #ddd; box-sizing: border-box;">
            </div>
            <p><b>é è¨­é–‹å•Ÿæ¬Šé™ï¼š</b></p>
            <div id="role-perm-grid" class="perm-grid"></div>
            <div style="margin-top:20px;">
                <button onclick="saveRoleTemplate()" style="width:100%; padding:12px; background:#673AB7; color:white; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">å„²å­˜è·ä½æ¨¡æ¿</button>
                <button onclick="closeModal('roleModal')" style="width:100%; padding:10px; background:#eee; border:none; border-radius:5px; margin-top:10px; cursor:pointer;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
    const MENUS = ["ğŸš© é–‹åº—æ­¥é©Ÿ", "ğŸ  å•†åº—æ¦‚æ³", "âš™ï¸ å•†åº—è¨­å®š", "ğŸª„ æ¨£å¼è¨­å®š", "ğŸ‘¥ äººå“¡ç®¡ç†", "ğŸ“¦ å•†å“ç®¡ç†", "ğŸ·ï¸ ä¿ƒéŠ·ç®¡ç†", "ğŸ“‹ è¨‚å–®ç®¡ç†", "ğŸ“¢ è¡ŒéŠ·æ¨å»£", "ğŸ‘¤ é¡§å®¢ç®¡ç†", "ğŸ¯ ç‹™æ“Šè¿½å–®", "ğŸ“ˆ æ•¸æ“šåˆ†æ", "ğŸ“ æ–‡ç« ç®¡ç†"];
    const storeSubItems = ["åŸºæœ¬è¨­å®š", "æ”¶æ¬¾æ–¹å¼", "é€è²¨æ–¹å¼", "é€€è²¨æ–¹å¼", "å€‰å„²æ–¹å¼", "è³¼ç‰©è»Šç®¡ç†", "è³‡æ–™åŒ¯å‡ºè¨­å®š"];
    const staffSubItems = ["äººå“¡åˆ—è¡¨", "è·ä½ç®¡ç†"];

    let ROLES_DATA = {
        "è€é—†": MENUS,
        "åº—é•·": ["ğŸ  å•†åº—æ¦‚æ³", "ğŸ‘¥ äººå“¡ç®¡ç†", "ğŸ“¦ å•†å“ç®¡ç†", "ğŸ“‹ è¨‚å–®ç®¡ç†"],
        "ç¶­ä¿®æŠ€å¸«": ["ğŸ“¦ å•†å“ç®¡ç†", "ğŸ“‹ è¨‚å–®ç®¡ç†"]
    };

    let allStaffData = [];

    window.onload = function() {
        renderSidebar();
        switchTab('äººå“¡åˆ—è¡¨'); 
    };

    function renderSidebar() {
        const sidebar = document.getElementById('sidebar-menu');
        sidebar.innerHTML = MENUS.map(m => {
            if (m === "âš™ï¸ å•†åº—è¨­å®š") return renderSubGroup(m, "sub-store", storeSubItems);
            if (m === "ğŸ‘¥ äººå“¡ç®¡ç†") return renderSubGroup(m, "sub-staff", staffSubItems);
            return `<div class="menu-item" onclick="switchTab('${m}')">${m}</div>`;
        }).join('');
    }

    function renderSubGroup(parentName, id, subs) {
        return `
            <div class="menu-item" onclick="toggleSub('${id}', this)">${parentName} <span style="float:right; font-size:10px;">â–¼</span></div>
            <div id="${id}" style="display:none;">
                ${subs.map(s => `<div class="menu-item sub-item" onclick="switchTab('${s}')">${s}</div>`).join('')}
            </div>`;
    }

    function toggleSub(id, el) {
        const box = document.getElementById(id);
        const isHidden = box.style.display === 'none';
        box.style.display = isHidden ? 'block' : 'none';
        el.querySelector('span').innerText = isHidden ? 'â–²' : 'â–¼';
    }

    function switchTab(tabName) {
        const content = document.getElementById('main-content');
        document.querySelectorAll('.menu-item').forEach(i => i.classList.toggle('active', i.innerText.includes(tabName)));
        if (tabName === 'äººå“¡åˆ—è¡¨') renderStaffListPage(content);
        else if (tabName === 'è·ä½ç®¡ç†') renderRoleManagerPage(content);
        else content.innerHTML = `<div class="card"><h2>${tabName} é é¢å»ºç½®ä¸­</h2></div>`;
    }

     function renderStaffListPage(container) {
    container.innerHTML = `
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                <h2 style="margin:0;">ğŸ‘¥ äººå“¡åˆ—è¡¨</h2>
                <div style="display:flex; gap:10px; flex:1; justify-content:flex-end;">
                    <input type="text" id="staffSearchInput" onkeyup="filterStaff()" placeholder="æœå°‹å§“åæˆ– Email..." 
                           style="padding:8px 15px; border-radius:50px; border:1px solid #ddd; width:250px;">
                    <button class="login-btn" style="width:auto; padding:10px 20px;" onclick="openAddModal()">ï¼‹ æ–°å¢äººå“¡</button>
                </div>
            </div>
            <table id="staff-table">
        <thead>
            <tr><th>è·ä½</th><th>ç¨±å‘¼ / Line ç‹€æ…‹</th><th>Email</th><th>æ¬Šé™æ•¸</th><th>æ“ä½œ</th></tr>
        </thead>
        <tbody id="staff-list-body">
                    <tr><td colspan="5" style="text-align:center;">è³‡æ–™è®€å–ä¸­...</td></tr>
                </tbody>
            </table>
        </div>`;
    loadStaff();
}

    function loadStaff() {
        // æ¥å›ä½ åŸæœ¬çš„ API è®€å–é‚è¼¯
        fetch('/api/staff').then(res => res.json()).then(data => {
            allStaffData = data;
document.getElementById('staff-list-body').innerHTML = data.map(u => {
    // 1. å…ˆåˆ¤æ–· Line ç‹€æ…‹ (å‡è¨­å¾Œç«¯æ¬„ä½å« line_bound)
    const lineTag = u.line_bound 
        ? '<span class="line-status line-on">å·²é€£å‹•</span>' 
        : '<span class="line-status line-off">æœªé€£å‹•</span>';

    return `
        <tr>
            <td><span class="role-tag">${u.role || 'è‡ªè¨‚'}</span></td>
            <td><strong>${u.name}</strong> ${lineTag}</td>
            <td>${u.email}</td>
            <td>${u.permissions.length} é …</td>
<td>
    <button class="edit-btn" onclick='openEditModal(${JSON.stringify(u)})'>ä¿®æ”¹</button>
    ${u.id != 1 ? `<button class="del-btn" onclick="deleteStaff(${u.id})">åˆªé™¤</button>` : ''}
</td>
        </tr>`;
}).join('');
        }).catch(err => {
            console.log("ç›®å‰ç„¡å¾Œç«¯é€£ç·šï¼Œåˆ—è¡¨é¡¯ç¤ºç‚ºç©º");
        });
    }

    function renderRoleManagerPage(container) {
        container.innerHTML = `
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 style="margin:0;">âš™ï¸ è·ä½æ¨¡æ¿ç®¡ç†</h2>
                    <button class="login-btn" style="width:auto; padding:10px 20px; background:#673AB7;" onclick="openRoleModal()">ï¼‹ æ–°å¢è·ä½æ¨¡æ¿</button>
                </div>
                <p style="color:#666; font-size:14px; margin-top:10px;">é€™è£¡è¨­å®šçš„è·ä½æ¬Šé™ï¼Œæœƒåœ¨æ–°å¢äººå“¡æ™‚ä½œç‚ºã€Œé è¨­å‹¾é¸ã€çš„ç¯„æœ¬ã€‚</p>
                <table>
                    <thead><tr><th>è·ä½åç¨±</th><th>é è¨­æ¬Šé™</th><th>æ“ä½œ</th></tr></thead>
                    <tbody>
                        ${Object.keys(ROLES_DATA).map(role => `
                            <tr>
                                <td><strong>${role}</strong></td>
                                <td><small>${ROLES_DATA[role].length} é …åŠŸèƒ½</small></td>
                                <td>
                                    <button class="edit-btn" onclick="openEditRoleModal('${role}')">ä¿®æ”¹</button>
                                    ${role !== 'è€é—†' ? `<button class="del-btn" onclick="deleteRole('${role}')">åˆªé™¤</button>` : ''}
                                </td>
                            </tr>`).join('')}
                    </tbody>
                </table>
            </div>`;
    }

    // --- äººå“¡ç®¡ç†é‚è¼¯ ---
    function openAddModal() { setupStaffModal("æ–°å¢äººå“¡", { id: "", name: "", email: "", role: "", permissions: [] }); }
    function openEditModal(u) { setupStaffModal("ä¿®æ”¹äººå“¡è³‡æ–™", u); }
    function setupStaffModal(title, u) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('editId').value = u.id;
        document.getElementById('newName').value = u.name;
        document.getElementById('newEmail').value = u.email;
        const select = document.getElementById('staffRoleSelect');
        select.innerHTML = `<option value="">-- æ‰‹å‹•å‹¾é¸æ¬Šé™ --</option>` + Object.keys(ROLES_DATA).map(r => `<option value="${r}" ${u.role===r?'selected':''}>${r}</option>`).join('');
        document.getElementById('perm-grid').innerHTML = MENUS.map(m => `<label><input type="checkbox" class="perm-cb" value="${m}" ${u.permissions.includes(m)?'checked':''}> ${m}</label>`).join('');
        document.getElementById('staffModal').style.display = 'flex';
    }
    function autoCheckPermissions(roleName) {
        const perms = ROLES_DATA[roleName] || [];
        document.querySelectorAll('.perm-cb').forEach(cb => cb.checked = perms.includes(cb.value));
    }
    function saveStaff() {
        const id = document.getElementById('editId').value;
        const body = {
            name: document.getElementById('newName').value,
            email: document.getElementById('newEmail').value,
            role: document.getElementById('staffRoleSelect').value,
            permissions: Array.from(document.querySelectorAll('.perm-cb:checked')).map(cb => cb.value)
        };
        fetch(id ? `/api/staff/${id}` : '/api/staff', {
            method: id ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        }).then(() => { closeModal('staffModal'); switchTab('äººå“¡åˆ—è¡¨'); });
    }

    // --- è·ä½æ¨¡æ¿ç®¡ç†é‚è¼¯ ---
    function openRoleModal() {
        document.getElementById('roleModalTitle').innerText = "ï¼‹ æ–°å¢è·ä½æ¨¡æ¿";
        document.getElementById('roleNameInput').value = "";
        document.getElementById('roleNameInput').disabled = false;
        renderRolePermGrid([]);
        document.getElementById('roleModal').style.display = 'flex';
    }
    function openEditRoleModal(roleName) {
        document.getElementById('roleModalTitle').innerText = "ğŸ“ ä¿®æ”¹è·ä½ï¼š" + roleName;
        document.getElementById('roleNameInput').value = roleName;
        document.getElementById('roleNameInput').disabled = true;
        renderRolePermGrid(ROLES_DATA[roleName] || []);
        document.getElementById('roleModal').style.display = 'flex';
    }
    function renderRolePermGrid(selectedPerms) {
        document.getElementById('role-perm-grid').innerHTML = MENUS.map(m => `
            <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
                <input type="checkbox" class="role-cb" value="${m}" ${selectedPerms.includes(m) ? 'checked' : ''}> ${m}
            </label>
        `).join('');
    }
    function saveRoleTemplate() {
        const name = document.getElementById('roleNameInput').value.trim();
        const perms = Array.from(document.querySelectorAll('.role-cb:checked')).map(cb => cb.value);
        if(!name) return alert("è«‹å¡«å¯«è·ä½åç¨±ï¼");
        ROLES_DATA[name] = perms;
        alert("è·ä½æ¨¡æ¿å·²å„²å­˜ï¼");
        closeModal('roleModal'); switchTab('è·ä½ç®¡ç†');
    }

    function deleteRole(role) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { delete ROLES_DATA[role]; switchTab('è·ä½ç®¡ç†'); } }
    function deleteStaff(id) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) fetch(`/api/staff/${id}`, { method: 'DELETE' }).then(() => switchTab('äººå“¡åˆ—è¡¨')); }
    function closeModal(mid) { document.getElementById(mid).style.display = 'none'; }
    function filterStaff() {
    const val = document.getElementById('staffSearchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#staff-list-body tr');
    rows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(val) ? '' : 'none';
    });
}
    </script>
</body>
</html>