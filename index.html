<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å•†å®¶å¾Œå°ç®¡ç†ç³»çµ±</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: "Microsoft JhengHei", sans-serif; background: #f9f9f9; }
        
        /* ç™»å…¥ä»‹é¢æ¨£å¼é–å®š */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 30px; width: 420px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        .line-btn { background: #06C755; color: white; border: none; padding: 15px; border-radius: 50px; cursor: pointer; width: 100%; font-weight: bold; margin-bottom: 25px; font-size: 16px; }
        .input-group { margin-bottom: 15px; }
        .input-group input { width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 50px; box-sizing: border-box; font-size: 16px; outline: none; }
        .login-btn { width: 100%; padding: 15px; background: linear-gradient(to right, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 50px; cursor: pointer; font-size: 18px; font-weight: bold; margin-bottom: 15px; }
        .forget-pwd { color: #3F51B5; text-decoration: none; font-size: 14px; display: block; margin-top: 10px; }

        /* ä¸»å¾Œå°æ¨£å¼é–å®š */
        #admin-main { display: none; height: 100vh; flex-direction: column; }
        .header { background: #3F51B5; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .main-body { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 220px; background: white; border-right: 1px solid #eee; overflow-y: auto; }
        .menu-item { padding: 12px 20px; cursor: pointer; color: #555; font-size: 14px; border-bottom: 1px solid #fafafa; }
        .menu-item.active { background: #f0f2ff; color: #3F51B5; border-left: 4px solid #3F51B5; font-weight: bold; }
        
        .content { flex: 1; padding: 30px; overflow-y: auto; }
        .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        /* è¦–è¦ºæŒ‰éˆ•é–å®šï¼šé»ƒè‰²ä¿®æ”¹ã€ç´…è‰²åˆªé™¤ */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; }
        .edit-btn { background: #FFC107; color: #000; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 8px; }
        .del-btn { background: #F44336; color: #fff; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .bind-btn { background: #06C755; color: white; border: none; padding: 8px 15px; border-radius: 50px; cursor: pointer; font-size: 13px; font-weight: bold; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 10000; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 480px; }
        .perm-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; font-size: 13px; }
        /* ç•¶é¸å–®è¢«é¸ä¸­æ™‚çš„æ¨£å¼ */
.menu-item.active {
    background-color: #e8eaf6 !important; /* æ·¡æ·¡çš„ç´«è‰²èƒŒæ™¯ */
    color: #3F51B5 !important;           /* æ–‡å­—è®Šæˆæ·±è—ç´«è‰² */
    border-left: 5px solid #3F51B5;      /* å·¦å´å‡ºç¾ä¸€æ¢ç²—é‚Šæ¡† */
    font-weight: bold;                   /* æ–‡å­—åŠ ç²— */
    transition: all 0.3s ease;           /* å¢åŠ å¹³æ»‘è½‰å ´æ•ˆæœ */
}
    </style>
</head>
<body>

    <div id="login-overlay" style="display: none;">
        <div class="login-box">
            <div style="font-size:28px; font-weight:bold; color:#3F51B5; margin-bottom:5px;">MY LOGO</div>
            <div style="font-size:22px; margin-bottom: 25px;">å•†å®¶å¾Œå°ç™»å…¥</div>
            <button class="line-btn">ä½¿ç”¨ LINE å¿«é€Ÿç™»å…¥</button>
            <div style="border-top: 1px solid #eee; padding-top: 25px;">
                <div class="input-group"><input type="email" id="email" placeholder="ä¿¡ç®±"></div>
                <div class="input-group"><input type="password" id="password" placeholder="å¯†ç¢¼"></div>
                <button class="login-btn">ç™»å…¥</button>
            </div>
        </div>
    </div>

    <div id="admin-main" style="display: flex;">
        <div class="header">
            <span>ğŸ›’ MY SHOP ç®¡ç†ç³»çµ±</span>
            <div style="display:flex; align-items:center; gap:15px;">
                <span id="user-display">ğŸ‘¤ è€é—† (é–‹ç™¼æ¨¡å¼)</span>
                <button class="bind-btn">ğŸ”— ç¶å®šå€‹äºº LINE</button>
                <button onclick="location.reload()" style="background:none; border:1px solid white; color:white; padding:5px 10px; border-radius:4px; cursor:pointer;">é‡æ–°æ•´ç†</button>
            </div>
        </div>
        <div class="main-body">
            <div class="sidebar" id="sidebar-menu"></div>
            <div class="content">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h2 style="margin:0;">ğŸ‘¥ äººå“¡ç®¡ç†</h2>
                        <button class="login-btn" style="width:auto; padding:10px 20px; font-size:14px;" onclick="openAddModal()">ï¼‹ æ–°å¢äººå“¡</button>
                    </div>
                    <table>
                        <thead>
                            <tr><th>ç¨±å‘¼</th><th>Email</th><th>LINE ç‹€æ…‹</th><th>æ¬Šé™</th><th>æ“ä½œ</th></tr>
                        </thead>
                        <tbody id="staff-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="staffModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">æ–°å¢äººå“¡</h3>
            <input type="hidden" id="editId">
            <div class="input-group"><input type="text" id="newName" placeholder="äººå“¡ç¨±å‘¼"></div>
            <div class="input-group"><input type="email" id="newEmail" placeholder="ç™»å…¥ Email"></div>
            <div class="input-group"><input type="password" id="newPass" placeholder="å¯†ç¢¼"></div>
            <p><b>æŒ‡æ´¾åŠŸèƒ½æ¬Šé™ï¼š</b></p>
            <div id="perm-grid" class="perm-grid"></div>
            <div style="margin-top:20px;">
                <button onclick="saveStaff()" style="width:100%; padding:12px; background:#3F51B5; color:white; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">å„²å­˜è¨­å®š</button>
                <button onclick="closeModal()" style="width:100%; padding:10px; background:#eee; border:none; border-radius:5px; margin-top:10px; cursor:pointer;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
    // 1. å®šç¾©é¸å–®è³‡æ–™ (ç¶­æŒä½ åŸæœ¬çš„ 13 é …)
    const MENUS = ["ğŸš© é–‹åº—æ­¥é©Ÿ", "ğŸ  å•†åº—æ¦‚æ³", "âš™ï¸ å•†åº—è¨­å®š", "ğŸª„ æ¨£å¼è¨­å®š", "ğŸ‘¥ äººå“¡ç®¡ç†", "ğŸ“¦ å•†å“ç®¡ç†", "ğŸ·ï¸ ä¿ƒéŠ·ç®¡ç†", "ğŸ“‹ è¨‚å–®ç®¡ç†", "ğŸ“¢ è¡ŒéŠ·æ¨å»£", "ğŸ‘¤ é¡§å®¢ç®¡ç†", "ğŸ¯ ç‹™æ“Šè¿½å–®", "ğŸ“ˆ æ•¸æ“šåˆ†æ", "ğŸ“ æ–‡ç« ç®¡ç†"];
    // å•†åº—è¨­å®šçš„å­é …ç›® (å…± 8 é …)
    const storeSubItems = ["åŸºæœ¬è¨­å®š", "æ”¶æ¬¾æ–¹å¼", "é€è²¨æ–¹å¼", "é€€è²¨æ–¹å¼", "å€‰å„²æ–¹å¼", "è³¼ç‰©è»Šç®¡ç†", "è³‡æ–™åŒ¯å‡ºè¨­å®š", "è‡ªè¨‚301è½‰å€"];

    window.onload = function() {
        renderSidebar();
        // é é¢åˆæ¬¡è¼‰å…¥æ™‚ï¼Œç›´æ¥é¡¯ç¤ºäººå“¡ç®¡ç†
        switchTab('ğŸ‘¥ äººå“¡ç®¡ç†');
    };

    // ç”Ÿæˆå·¦å´é¸å–®é‚è¼¯
    function renderSidebar() {
        const sidebar = document.getElementById('sidebar-menu');
        sidebar.innerHTML = MENUS.map(m => {
            // åœ¨ renderSidebar å‡½å¼å…§å°‹æ‰¾ä¸¦ä¿®æ”¹é€™æ®µ
if (m === "âš™ï¸ å•†åº—è¨­å®š") {
    return `
        <div class="menu-item" onclick="toggleStoreMenu(this)">
            ${m} <span style="float:right; font-size:10px;">â–¼</span>
        </div>
        <div id="sub-store-box" style="display:none; background:#f4f6ff; border-left: 2px solid #ddd;">
            ${storeSubItems.map(sub => `
                <div class="menu-item sub-item" style="padding-left:40px; font-size:13px;" onclick="switchTab('${sub}')">
                    ${sub}
                </div>
            `).join('')}
        </div>
    `;
}
            return `<div class="menu-item ${m==='ğŸ‘¥ äººå“¡ç®¡ç†'?'active':''}" onclick="switchTab('${m}')">${m}</div>`;
        }).join('');
    }

    // æ§åˆ¶å•†åº—è¨­å®šä¸‹æ‹‰
    function toggleStoreMenu(el) {
        const box = document.getElementById('sub-store-box');
        const isHidden = box.style.display === 'none';
        box.style.display = isHidden ? 'block' : 'none';
        el.querySelector('span').innerText = isHidden ? 'â–²' : 'â–¼';
    }

    // åˆ‡æ›é é¢ä¸»é‚è¼¯
    function switchTab(tabName) {
    const contentDiv = document.querySelector('.content');

    // 1. è™•ç†é¸å–®é«˜äº®åæ‡‰
    document.querySelectorAll('.menu-item').forEach(item => {
        // å…ˆç§»é™¤æ‰€æœ‰äººçš„ active æ¨£å¼
        item.classList.remove('active');
        
        // å¦‚æœé¸å–®çš„æ–‡å­—å…§å®¹ã€ŒåŒ…å«ã€æˆ‘å€‘é»æ“Šçš„åç¨±ï¼Œå°±å¹«å®ƒåŠ ä¸Š active
        // ä½¿ç”¨ trim() æ˜¯ç‚ºäº†é¿å…ç©ºæ ¼å½±éŸ¿åˆ¤æ–·
        if (item.innerText.trim().includes(tabName)) {
            item.classList.add('active');
        }
    });

    // 2. åŸæœ‰çš„é é¢åˆ‡æ›é‚è¼¯
    if (tabName === 'ğŸ‘¥ äººå“¡ç®¡ç†') {
        renderStaffPage(contentDiv);
    } else if (tabName === 'åŸºæœ¬è¨­å®š') {
        renderBasicSettingsPage(contentDiv);
    } else {
        contentDiv.innerHTML = `<div class="card"><h2>${tabName} é é¢å»ºç½®ä¸­</h2></div>`;
    }
}

    // --- äººå“¡ç®¡ç†é é¢ ---
    function renderStaffPage(container) {
        container.innerHTML = `
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h2 style="margin:0;">ğŸ‘¥ äººå“¡ç®¡ç†</h2>
                    <button class="login-btn" style="width:auto; padding:10px 20px;" onclick="openAddModal()">ï¼‹ æ–°å¢äººå“¡</button>
                </div>
                <table>
                    <thead>
                        <tr><th>ç¨±å‘¼</th><th>Email</th><th>LINE ç‹€æ…‹</th><th>æ¬Šé™</th><th>æ“ä½œ</th></tr>
                    </thead>
                    <tbody id="staff-list"></tbody>
                </table>
            </div>`;
        loadStaff();
    }

    // è¼‰å…¥äººå“¡è³‡æ–™ (ä¿ç•™ä½ åŸæœ¬çš„ API ä¸²æ¥é‚è¼¯èˆ‡è€é—†ä¿è­·)
    function loadStaff() {
        fetch('/api/staff').then(res => res.json()).then(data => {
            const list = document.getElementById('staff-list');
            if(!list) return;
            list.innerHTML = data.map(u => `
                <tr>
                    <td>${u.name}</td>
                    <td>${u.email}</td>
                    <td>${u.lineId ? '<span style="color:green; font-weight:bold;">å·²é€£å‹•</span>' : '<span style="color:red; font-weight:bold;">æœªé€£å‹•</span>'}</td>
                    <td><small>${u.permissions.includes('all')?'å…¨éƒ¨':u.permissions.join(', ')}</small></td>
                    <td>
                        <button class="edit-btn" onclick='openEditModal(${JSON.stringify(u)})'>ä¿®æ”¹</button>
                        ${u.id != 1 ? `<button class="del-btn" onclick="deleteStaff(${u.id})">åˆªé™¤</button>` : ''}
                    </td>
                </tr>
            `).join('');
        });
    }

    // --- å½ˆçª—æ§åˆ¶ (ä¿®æ­£ï¼šæ¢å¾© 13 å€‹å®Œæ•´æ¬Šé™) ---
    function openAddModal() {
        document.getElementById('modalTitle').innerText = "æ–°å¢äººå“¡";
        document.getElementById('editId').value = "";
        document.getElementById('newName').value = "";
        document.getElementById('newEmail').value = "";
        document.getElementById('newPass').value = "";
        
        // æ¢å¾©é¡¯ç¤º MENUS è£¡æ‰€æœ‰çš„ 13 å€‹æ¬Šé™
        document.getElementById('perm-grid').innerHTML = MENUS.map(m => `
            <label style="display:flex; align-items:center; gap:5px; font-size:14px;">
                <input type="checkbox" value="${m}"> ${m}
            </label>
        `).join('');
        
        document.getElementById('staffModal').style.display = 'flex';
    }

    function openEditModal(u) {
        document.getElementById('modalTitle').innerText = "ä¿®æ”¹äººå“¡è³‡æ–™";
        document.getElementById('editId').value = u.id;
        document.getElementById('newName').value = u.name;
        document.getElementById('newEmail').value = u.email;
        document.getElementById('newPass').value = "";
        
        // ç·¨è¼¯æ™‚åŒæ¨£æ¢å¾© 13 å€‹å®Œæ•´æ¬Šé™æ¸…å–®
        document.getElementById('perm-grid').innerHTML = MENUS.map(m => `
            <label style="display:flex; align-items:center; gap:5px; font-size:14px;">
                <input type="checkbox" value="${m}" ${u.permissions.includes(m)?'checked':''}> ${m}
            </label>
        `).join('');
        document.getElementById('staffModal').style.display = 'flex';
    }

    // --- åŸºæœ¬è¨­å®šé é¢ (ä»¿ç…§æˆªåœ–æ’ç‰ˆ) ---
    function renderBasicSettingsPage(container) {
        container.innerHTML = `
            <div class="card">
                <h2 style="color:#3F51B5; border-bottom:1px solid #eee; padding-bottom:10px;">âš™ï¸ åŸºæœ¬è¨­å®š</h2>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div style="border:1px solid #eee; padding:15px; border-radius:10px; background:#fafafa;">
                        <h4 style="margin-top:0; color:#3F51B5;">ğŸ”— å‰å°ç¤¾ç¾¤é€£çµ</h4>
                        <div class="input-group"><label>Facebook</label><input type="text" placeholder="URL"></div>
                        <div class="input-group"><label>Instagram</label><input type="text" placeholder="URL"></div>
                        <div class="input-group"><label>LINE ID</label><input type="text" value="@550hhzzh"></div>
                    </div>
                    <div style="border:1px solid #eee; padding:15px; border-radius:10px; background:#fafafa;">
                        <h4 style="margin-top:0; color:#3F51B5;">ğŸ” SEO ç›¸é—œè¨­å®š</h4>
                        <div class="input-group"><label>é¦–é æ¨™é¡Œ (SEO Title)</label><input type="text" value="è²“è‘£ | å…¨å°æ‰‹æ©Ÿç¶­ä¿®"></div>
                        <div class="input-group"><label>é¦–é æè¿° (Description)</label><textarea style="width:100%; height:60px;"></textarea></div>
                    </div>
                </div>
                <div style="text-align:center; margin-top:20px;">
                    <button class="login-btn" style="width:200px;" onclick="alert('è¨­å®šå·²å„²å­˜')">å„²å­˜åŸºæœ¬è¨­å®š</button>
                </div>
            </div>`;
    }

    function saveStaff() {
        const id = document.getElementById('editId').value;
        const body = {
            name: document.getElementById('newName').value,
            email: document.getElementById('newEmail').value,
            permissions: Array.from(document.querySelectorAll('#perm-grid input:checked')).map(c => c.value)
        };
        const pass = document.getElementById('newPass').value;
        if(pass) body.password = pass;

        fetch(id ? `/api/staff/${id}` : '/api/staff', {
            method: id ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        }).then(() => { closeModal(); switchTab('ğŸ‘¥ äººå“¡ç®¡ç†'); });
    }

    function deleteStaff(id) {
        if(confirm('ç¢ºå®šåˆªé™¤æ­¤äººå“¡ï¼Ÿ')) fetch(`/api/staff/${id}`, { method: 'DELETE' }).then(() => switchTab('ğŸ‘¥ äººå“¡ç®¡ç†'));
    }

    function closeModal() { document.getElementById('staffModal').style.display = 'none'; }
</script>
</body>
</html>